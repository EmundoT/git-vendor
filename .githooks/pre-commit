#!/bin/bash
set -e

echo "üîç Running pre-commit checks..."

# 1. Format check
echo "  ‚Üí Checking formatting..."
if [ -n "$(gofmt -l .)" ]; then
  echo "‚ùå Code is not formatted. Run: gofmt -w ."
  gofmt -l .
  exit 1
fi

# 2. Generate mocks
echo "  ‚Üí Generating mocks..."
make mocks > /dev/null 2>&1

# 3. Check for uncommitted mock files
if git diff --name-only | grep -q "_mock_test.go"; then
  echo "‚ö†Ô∏è  Mock files changed but are git-ignored (expected)"
fi

# 4. Run tests
echo "  ‚Üí Running tests..."
if ! go test ./... > /dev/null 2>&1; then
  echo "‚ùå Tests failed. Fix them before committing."
  exit 1
fi

# 5. Check for debugging artifacts
echo "  ‚Üí Checking for debugging artifacts..."
if git diff --cached --name-only | xargs grep -l "fmt.Println\|panic(\"TODO" 2>/dev/null; then
  echo "‚ö†Ô∏è  Found debugging statements. Remove them or commit anyway?"
  read -p "Continue? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

echo "‚úÖ Pre-commit checks passed!"
