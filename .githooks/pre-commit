#!/bin/bash
set -e

# Ensure Go binaries are in PATH
export PATH="/home/emt/go/bin:/usr/local/go/bin:$PATH"

echo "üîç Running pre-commit checks..."

# 1. Format check (exclude vendor/)
echo "  ‚Üí Checking formatting..."
UNFORMATTED=$(gofmt -l . | grep -v "^vendor/")
if [ -n "$UNFORMATTED" ]; then
  echo "‚ùå Code is not formatted. Run: gofmt -w ."
  echo "$UNFORMATTED"
  exit 1
fi

# 2. Generate mocks
echo "  ‚Üí Generating mocks..."
make mocks > /dev/null 2>&1

# 3. Check for uncommitted mock files
if git diff --name-only | grep -q "_mock_test.go"; then
  echo "‚ö†Ô∏è  Mock files changed but are git-ignored (expected)"
fi

# 4. Run tests
echo "  ‚Üí Running tests..."
if ! go test -mod=mod ./... > /dev/null 2>&1; then
  echo "‚ùå Tests failed. Fix them before committing."
  exit 1
fi

# 5. Check for debugging artifacts (only in non-main Go files)
echo "  ‚Üí Checking for debugging artifacts..."
DEBUG_PATTERNS="DEBUG:\|FIXME:\|XXX:\|HACK:\|panic(\"TODO"
if git diff --cached --name-only | grep -v "^\.githooks/" | grep -v "^main.go$" | grep "\.go$" | xargs grep -l "$DEBUG_PATTERNS" 2>/dev/null; then
  echo "‚ö†Ô∏è  Found debugging statements. Remove them or commit anyway?"
  read -p "Continue? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

echo "‚úÖ Pre-commit checks passed!"
