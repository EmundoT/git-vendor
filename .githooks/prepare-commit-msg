#!/bin/bash
# prepare-commit-msg â€” COMMIT-SCHEMA v1 enrichment hook
# Adds: Commit-Schema: manual/v1, Touch, Diff-Additions/Deletions/Files, Diff-Surface
# Progressive enhancement: uses git-plumbing binary if available, bash fallback otherwise.

MSG_FILE="$1"
SOURCE="$2"
SHA="$3"

# Skip merge commits, squash, amend
case "$SOURCE" in
  merge|squash) exit 0 ;;
esac

# --- Tier 1: git-plumbing binary (full enrichment) ---
if command -v git-plumbing &>/dev/null; then
  git-plumbing hook prepare-commit-msg "$MSG_FILE" "$SOURCE" "$SHA"
  exit $?
fi

# --- Tier 2: bash fallback (~80% fidelity) ---
MSG=$(cat "$MSG_FILE")

# Skip if already has Commit-Schema (idempotent)
if echo "$MSG" | grep -q "^Commit-Schema:"; then
  exit 0
fi

# Compute diff metrics from staged changes
NUMSTAT=$(git diff --cached --numstat 2>/dev/null)
if [ -n "$NUMSTAT" ]; then
  ADDITIONS=$(echo "$NUMSTAT" | awk '{s+=$1} END {print s+0}')
  DELETIONS=$(echo "$NUMSTAT" | awk '{s+=$2} END {print s+0}')
  FILES=$(echo "$NUMSTAT" | wc -l | tr -d ' ')
else
  ADDITIONS=0
  DELETIONS=0
  FILES=0
fi

# Classify primary surface from staged file paths
STAGED=$(git diff --cached --name-only 2>/dev/null)
SURFACE="internal"
if echo "$STAGED" | grep -qE '(^cmd/|^api/|handler)'; then
  SURFACE="api"
elif echo "$STAGED" | grep -qE '(migration|schema)'; then
  SURFACE="data"
elif echo "$STAGED" | grep -qE '\.(yml|yaml|toml|json)$'; then
  SURFACE="config"
elif echo "$STAGED" | grep -qE '(_test\.go$|__tests__)'; then
  SURFACE="test"
elif echo "$STAGED" | grep -qE '(\.md$|^docs/|LICENSE)'; then
  SURFACE="docs"
fi

# Append trailers (blank line + trailers)
{
  echo ""
  echo "Commit-Schema: manual/v1"
  echo "Diff-Additions: $ADDITIONS"
  echo "Diff-Deletions: $DELETIONS"
  echo "Diff-Files: $FILES"
  echo "Diff-Surface: $SURFACE"
} >> "$MSG_FILE"
