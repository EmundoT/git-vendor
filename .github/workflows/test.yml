name: Tests

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]
  #   paths:
  #     - '**.go'
  #     - 'go.mod'
  #     - 'go.sum'
  #     - 'Makefile'
  # pull_request:
  #   branches: [ main ]
  #   paths:
  #     - '**.go'
  #     - 'go.mod'
  #     - 'go.sum'
  #     - 'Makefile'

# Cancel in-progress jobs from previous pushes to the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Don't kill all jobs if just one OS fails
      matrix:
        # Optimization: Only run the expensive OSs on PRs, not every push to main
        os: >-
          ${{ github.event_name == 'pull_request' 
              && fromJSON('["ubuntu-latest", "windows-latest", "macos-latest"]') 
              || fromJSON('["ubuntu-latest"]') 
          }}
        go: ['1.23']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true # Enable automatic caching of Go modules

      - name: Install mockgen
        run: go install github.com/golang/mock/mockgen@latest

      - name: Generate mocks
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            MOCKGEN="$(go env GOPATH)/bin/mockgen"
            $MOCKGEN -source=internal/core/git_operations.go -destination=internal/core/git_client_mock_test.go -package=core
            # ... (keep your specific windows mocks here)
          else
            make mocks
          fi
        shell: bash

      - name: Run tests
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            go test -mod=mod -v -race -tags=integration ./...
          else
            go test -mod=mod -v -race -tags=integration -coverprofile=coverage.txt -covermode=atomic ./...
          fi
        shell: bash

      - name: Upload coverage
        if: runner.os == 'Linux' # Only upload once to save time/resources
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.txt