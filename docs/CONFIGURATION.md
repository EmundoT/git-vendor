# Configuration Reference

Complete reference for vendor.yml and vendor.lock file formats.

## Table of Contents

- [vendor.yml Format](#vendoryml-format)
- [vendor.lock Format](#vendorlock-format)
- [Field Reference](#field-reference)
- [Validation Rules](#validation-rules)
- [Best Practices](#best-practices)
- [Examples](#examples)

---

## vendor.yml Format

**Location:** `.git-vendor/vendor.yml`

Main configuration file defining all vendor dependencies.

### Basic Structure

```yaml
vendors:
  - name: string                    # Required
    url: string                     # Required
    mirrors: []string               # Optional (schema v1.3+)
    license: string                 # Auto-detected
    groups: []string                # Optional
    hooks:                          # Optional
      pre_sync: string
      post_sync: string
    specs:                          # Required (≥1)
      - ref: string                 # Required
        default_target: string      # Optional
        mapping:                    # Required (≥1)
          - from: string            # Required
            to: string              # Optional (empty=auto)
```

### Complete Example

```yaml
vendors:
  - name: example-lib
    url: https://github.com/owner/repo
    license: MIT
    groups: ["frontend", "ui"]
    hooks:
      pre_sync: echo "Preparing to sync example-lib..."
      post_sync: |
        npm install
        npm run build
    specs:
      - ref: main
        default_target: "vendor/example/"
        mapping:
          - from: src/utils
            to: internal/vendor/example-utils
          - from: src/types.go
            to: internal/vendor/types.go
```

---

## vendor.lock Format

**Location:** `.git-vendor/vendor.lock`

Lock file storing exact commit hashes for reproducibility.

### Structure

```yaml
vendors:
  - name: string
    ref: string
    commit_hash: string
    license_path: string
    updated: string (ISO8601)
    source_url: string              # Schema v1.3+: which URL served the content (empty = primary)
```

### Example

```yaml
vendors:
  - name: example-lib
    ref: main
    commit_hash: abc123def456789...
    license_path: .git-vendor/licenses/example-lib.txt
    updated: "2024-12-27T10:30:45Z"
  - name: another-lib
    ref: v1.0.0
    commit_hash: fed987cba654321...
    license_path: .git-vendor/licenses/another-lib.txt
    updated: "2024-12-27T10:31:20Z"
```

**⚠️ IMPORTANT:** Never edit this file manually. It's automatically generated by `git-vendor update` and `git-vendor sync` commands.

---

## Field Reference

### VendorSpec

Top-level vendor configuration.

#### name (required)

**Type:** `string`
**Description:** Display name for the vendor
**Validation:**

- Must be unique across all vendors
- Cannot be empty
- Recommended: Use descriptive names

**Examples:**

```yaml
✅ name: "charmbracelet-lipgloss"
✅ name: "golang-mock"
❌ name: "lib1"  # Too generic
❌ name: ""      # Empty (invalid)
```

#### url (required)

**Type:** `string`
**Description:** Git repository URL
**Validation:**

- Must be valid Git URL
- Supported protocols: https://, git://, ssh://
- Can be GitHub, GitLab, Bitbucket, or generic Git

**Examples:**

```yaml
✅ url: "https://github.com/owner/repo"
✅ url: "git@github.com:owner/repo.git"
✅ url: "https://gitlab.com/group/subgroup/project"
✅ url: "git://git.kernel.org/pub/scm/git/git.git"
❌ url: "not-a-url"  # Invalid format
```

#### mirrors (optional, schema v1.3+)

**Type:** `[]string`
**Description:** Fallback mirror URLs tried after the primary URL fails during sync, update, diff, and outdated operations. Mirrors are tried in declaration order.
**Validation:**

- Each URL must be a valid Git URL
- Must not duplicate the primary URL
- Must not be empty strings
- Not supported for internal vendors (`source: internal`)

**Example:**

```yaml
mirrors:
  - "https://gitlab.com/owner/repo"
  - "https://internal.corp/mirrors/repo"
```

#### license (auto-detected)

**Type:** `string`
**Description:** SPDX license identifier
**Auto-detected:** Yes (via API or LICENSE file)
**Validation:** Optional but recommended

**Pre-approved licenses:**

- MIT
- Apache-2.0
- BSD-3-Clause
- BSD-2-Clause
- ISC
- Unlicense
- CC0-1.0

**Examples:**

```yaml
✅ license: "MIT"
✅ license: "Apache-2.0"
⚠️ license: "Custom"  # Will prompt for confirmation
```

**Note:** If not specified, git-vendor will auto-detect the license during `add` or `update`.

#### groups (optional)

**Type:** `[]string`
**Description:** Array of group names for batch operations
**Default:** Empty
**Validation:** Can be empty

**Examples:**

```yaml
✅ groups: ["frontend", "ui"]
✅ groups: ["backend"]
✅ groups: []  # Valid (no groups)
```

**Use cases:**

```yaml
# Environment-specific
groups: ["development", "testing"]

# Platform-specific
groups: ["mobile", "ios"]

# Feature-specific
groups: ["authentication", "backend"]
```

#### hooks (optional)

**Type:** `HookConfig`
**Description:** Shell commands to run before/after sync
**Default:** No hooks

**Structure:**

```yaml
hooks:
  pre_sync: string # Optional: runs before sync
  post_sync: string # Optional: runs after sync
```

**Examples:**

```yaml
# Single-line commands
hooks:
  pre_sync: echo "Starting sync"
  post_sync: npm run build

# Multi-line commands
hooks:
  post_sync: |
    npm install
    npm run build
    echo "Build complete"
```

**See:** [Advanced Usage - Custom Hooks](./ADVANCED.md#custom-hooks) for full documentation.

#### specs (required)

**Type:** `[]BranchSpec`
**Description:** Array of git refs to track
**Validation:** Must have at least one spec

**Examples:**

```yaml
# Single ref
specs:
  - ref: main
    mapping: [...]

# Multiple refs
specs:
  - ref: v1.0
    mapping: [...]
  - ref: v2.0
    mapping: [...]
```

---

### BranchSpec

Configuration for a specific git ref.

#### ref (required)

**Type:** `string`
**Description:** Git branch, tag, or commit hash to track
**Validation:** Cannot be empty

**Examples:**

```yaml
✅ ref: "main"          # Branch
✅ ref: "v1.2.3"        # Tag
✅ ref: "abc123..."     # Commit hash (full)
❌ ref: ""              # Empty (invalid)
```

**Best practice:** Use tags for stable dependencies:

```yaml
✅ ref: "v1.0.0" # Stable, won't change
⚠️ ref: "main" # Changes frequently
```

#### default_target (optional)

**Type:** `string`
**Description:** Default destination directory for auto-named paths
**Default:** Empty (current directory)

**Examples:**

```yaml
default_target: "vendor/lib/"

# With auto-naming:
mapping:
  - from: src/utils
    to: "" # Auto-named as "vendor/lib/utils"
```

#### mapping (required)

**Type:** `[]PathMapping`
**Description:** Array of path mappings from remote to local
**Validation:** Must have at least one mapping

---

### PathMapping

Maps remote repository path to local destination.

#### from (required)

**Type:** `string`
**Description:** Path in remote repository (file or directory)
**Validation:** Cannot be empty

**Examples:**

```yaml
✅ from: "src/utils"           # Directory
✅ from: "src/config.go"       # File
✅ from: "lib/types/"          # Directory with trailing slash
✅ from: "."                   # Root directory
❌ from: ""                    # Empty (invalid)
```

#### to (optional)

**Type:** `string`
**Description:** Local destination path (relative to project root)
**Default:** Auto-named based on `from` and `default_target`
**Validation:** Must be relative (no `..`, no absolute paths)

**Examples:**

```yaml
✅ to: "internal/vendor/utils"     # Explicit path
✅ to: "lib/config.go"             # File destination
✅ to: ""                          # Auto-naming
❌ to: "/etc/passwd"               # Absolute (rejected)
❌ to: "../../../etc/passwd"       # Parent refs (rejected)
```

**Auto-naming logic:**

```yaml
# With default_target: "vendor/"
from: "src/utils"
to: ""             # → "vendor/utils"

# Without default_target
from: "src/utils"
to: ""             # → "utils"
```

---

## Validation Rules

git-vendor validates configuration on save and sync:

### Required Fields

1. ✅ **At least one vendor** - Config cannot be empty
2. ✅ **Vendor must have name** - `name` field required
3. ✅ **Vendor must have URL** - `url` field required
4. ✅ **At least one spec** - Each vendor needs ≥1 spec
5. ✅ **Spec must have ref** - `ref` field required
6. ✅ **At least one mapping** - Each spec needs ≥1 mapping
7. ✅ **Mapping must have 'from'** - `from` field required

### Uniqueness

8. ✅ **Unique vendor names** - No duplicate names allowed

### Security

9. ✅ **Valid Git URLs** - URL must be parseable
10. ✅ **Relative destination paths** - No absolute paths or `..` references

### Optional Warnings

11. ⚠️ **Path conflicts** - Multiple vendors mapping to same destination (warning, not error)

### Run Validation

```bash
git-vendor validate
```

**Example output:**

```text
✔ Validation passed. No issues found.

# Or with errors:
✖ Validation failed:
  • Vendor 'example' has no specs
  • Vendor 'another' has duplicate name
  • Invalid URL: "not-a-url"
```

---

## Best Practices

### 1. Use Descriptive Names

```yaml
✅ name: "charmbracelet-lipgloss"
❌ name: "lib1"
```

### 2. Lock to Stable Refs

```yaml
✅ ref: "v1.2.3" # Tag (stable)
⚠️ ref: "main" # Branch (changes)
```

### 3. Organize with Groups

```yaml
vendors:
  - name: react-ui
    groups: ["frontend", "ui"]
  - name: api-client
    groups: ["backend", "api"]
```

### 4. Use Hooks for Automation

```yaml
hooks:
  post_sync: |
    npm install
    npm run build
```

### 5. Explicit Path Mappings

```yaml
✅ mapping:
  - from: src/
    to: vendor/lib/

⚠️ mapping:
  - from: src/
    to: "" # Auto-naming (less predictable)
```

### 6. Validate Before Committing

```bash
git-vendor validate
git add .git-vendor/vendor.yml
git commit -m "Add vendor dependencies"
```

### 7. Commit Lockfile

```bash
git add .git-vendor/vendor.lock
git commit -m "Lock vendor versions"
```

### 8. Document Vendor Purpose

```yaml
# Use comments to explain why each vendor is needed
vendors:
  # UI styling library for terminal output
  - name: charmbracelet-lipgloss
    url: https://github.com/charmbracelet/lipgloss
```

---

## Examples

### Example 1: Simple Vendor

```yaml
vendors:
  - name: go-utils
    url: https://github.com/company/utils
    license: MIT
    specs:
      - ref: v1.0.0
        mapping:
          - from: pkg/strings
            to: internal/utils/strings
```

### Example 2: Multi-Ref Tracking

```yaml
vendors:
  - name: api-client
    url: https://github.com/company/api
    license: Apache-2.0
    specs:
      - ref: v1.0
        mapping:
          - from: client
            to: vendor/api-v1
      - ref: v2.0
        mapping:
          - from: client
            to: vendor/api-v2
```

### Example 3: With Hooks and Groups

```yaml
vendors:
  - name: frontend-components
    url: https://github.com/company/ui
    license: MIT
    groups: ["frontend", "ui"]
    hooks:
      post_sync: |
        cd vendor/ui
        npm install
        npm run build
    specs:
      - ref: main
        default_target: "vendor/ui/"
        mapping:
          - from: src/components
            to: "" # Auto: vendor/ui/components
```

### Example 4: Multiple Vendors

```yaml
vendors:
  # Backend utilities
  - name: backend-utils
    url: https://github.com/company/backend
    license: MIT
    groups: ["backend"]
    specs:
      - ref: v2.1.0
        mapping:
          - from: pkg/auth
            to: internal/auth
          - from: pkg/db
            to: internal/db

  # Frontend library
  - name: ui-components
    url: https://github.com/company/frontend
    license: MIT
    groups: ["frontend"]
    hooks:
      post_sync: npm run build
    specs:
      - ref: v1.5.0
        mapping:
          - from: src/
            to: vendor/ui/

  # Shared utilities
  - name: shared-utils
    url: https://github.com/company/shared
    license: Apache-2.0
    groups: ["backend", "frontend"]
    specs:
      - ref: main
        mapping:
          - from: utils/
            to: internal/shared/
```

### Example 5: Generic Git Repository

```yaml
vendors:
  - name: kernel-headers
    url: git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
    license: GPL-2.0
    specs:
      - ref: v6.1
        mapping:
          - from: include/linux
            to: vendor/kernel/include
```

---

## See Also

- [Commands Reference](./COMMANDS.md) - All available commands
- [Advanced Usage](./ADVANCED.md) - Hooks, groups, parallel processing
- [Validation](./COMMANDS.md#validate) - Configuration validation
- [Troubleshooting](./TROUBLESHOOTING.md) - Common configuration issues
