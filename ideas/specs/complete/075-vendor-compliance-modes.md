# Spec 075: Vendor Compliance Modes

> **Status:** Implemented (hook install deferred)
> **Priority:** P1 - Enforcement Foundation
> **Effort:** 1-2 weeks
> **Dependencies:** 002 (Verify Hardening)
> **Blocks:** 070 (Internal Compliance consumes this model), 022 (GitHub Action), 023 (Compliance Reports)

---

## Problem Statement

git-vendor can detect drift (`verify`) but has no enforcement model. A mismatch between vendored files and their lockfile hashes produces output but no consequences — builds succeed, commits land, and drift accumulates silently.

Enforcement needs differ by context:

1. **Strict compliance** (e.g., security-critical vendored code): Drift MUST block builds AND commits.
2. **Lenient compliance** (e.g., documentation snippets): Drift SHOULD block commits but MUST NOT block builds.
3. **Informational** (e.g., experimental vendors): Drift SHOULD be reported but MUST NOT block anything.

Today, 070 (Internal Compliance) defines `strictness` for `source: internal` vendors only. This spec generalizes the compliance model across ALL vendor types (external and internal) with a global default and per-vendor override.

---

## Non-Goals

- **Cross-project mismatch detection**: Comparing lockfiles across repositories is out of scope (see queue item 043).
- **Runtime enforcement**: This spec covers build-time and commit-time gates only. No runtime integrity checks.
- **License policy**: License allow/deny/warn lists remain in queue item 013. Compliance modes govern hash-based drift, not license status.

---

## Solution Overview

### Configuration

```yaml
# .git-vendor/vendor.yml

# Global compliance settings (new top-level block)
compliance:
  default: lenient         # Default level for all vendors: strict | lenient | info
  mode: default            # How per-vendor overrides work: default | override

vendors:
  # External vendor — inherits global default (lenient)
  - name: charmbracelet-huh
    url: https://github.com/charmbracelet/huh
    license: MIT
    specs:
      - ref: main
        mapping:
          - from: huh.go
            to: vendor/huh/huh.go

  # External vendor — escalates to strict
  - name: security-lib
    url: https://github.com/org/security-lib
    license: Apache-2.0
    compliance: strict
    specs:
      - ref: v2.1.0
        mapping:
          - from: src/
            to: vendor/security-lib/

  # Internal vendor — demotes to info (experimental)
  - name: readme-sync
    source: internal
    compliance: info
    specs:
      - mapping:
          - from: docs/COMMANDS.md
            to: README.md
            transform: extract-section
            section: "## Quick Reference"
```

### New Fields

| Field | Location | Type | Default | Description |
|-------|----------|------|---------|-------------|
| `compliance.default` | Top-level | `strict \| lenient \| info` | `lenient` | Global default compliance level |
| `compliance.mode` | Top-level | `default \| override` | `default` | How per-vendor settings interact with global |
| `compliance` | Per-vendor | `strict \| lenient \| info` | (inherits global) | Per-vendor compliance level |

### Mode Semantics

| Mode | Behavior |
|------|----------|
| `default` | Per-vendor `compliance` field overrides global default. Vendors without `compliance` inherit the global. |
| `override` | Global `compliance.default` wins for ALL vendors regardless of per-vendor setting. Useful for org-wide lockdown (e.g., "everything strict before release"). |

---

## Compliance Levels

| Level | `verify` exit code | Commit gate | Build gate | Use case |
|-------|-------------------|-------------|------------|----------|
| `strict` | 1 (FAIL) | Blocks | Blocks | Security-critical vendored code, schemas |
| `lenient` | 2 (WARN) | Blocks | Passes | Documentation, non-critical synced files |
| `info` | 0 (PASS) | Passes | Passes | Experimental vendors, best-effort sync |

### Exit Code Alignment with Spec 002

Spec 002 established exit codes: 0 = PASS, 1 = FAIL, 2 = WARN. Compliance modes map directly:

- `strict` drift → exit 1 (same as modified/deleted files today)
- `lenient` drift → exit 2 (same as added-only files today)
- `info` drift → exit 0 (reported in output, does not affect exit code)

When multiple vendors have different compliance levels, the **highest severity wins** for the exit code:
- Any `strict` drift → exit 1
- No strict drift, any `lenient` drift → exit 2
- Only `info` drift → exit 0

---

## Enforcement Mechanisms

### 1. Pre-Commit Hook (commit gate)

```bash
#!/bin/bash
# Generated by: git-vendor hook install --pre-commit

result=$(git-vendor verify --quiet 2>&1)
exit_code=$?

if [ $exit_code -eq 1 ]; then
    echo "ERROR: Vendor compliance failed (strict drift detected)"
    echo "$result"
    echo "Run 'git-vendor sync' to update, or 'git-vendor verify' for details"
    exit 1
elif [ $exit_code -eq 2 ]; then
    echo "ERROR: Vendor compliance warning (lenient drift detected)"
    echo "$result"
    echo "Run 'git-vendor sync' to update, or 'git-vendor verify' for details"
    exit 1  # Both strict and lenient block commits
fi
```

**Key**: Both `strict` and `lenient` block commits. The distinction is that `lenient` does NOT block builds.

### 2. Build Gate (build-time enforcement)

Build enforcement is opt-in via a generated check. Options by ecosystem:

#### Go: `go generate` guard

```go
//go:generate git-vendor verify --strict-only --quiet
```

Runs during `go generate`. Fails the generate step if any `strict` vendor has drift. Does NOT fail for `lenient` or `info` vendors.

#### Makefile target

```makefile
.PHONY: vendor-check
vendor-check:
	@git-vendor verify --strict-only --quiet || \
		(echo "Strict vendor compliance failed" && exit 1)

build: vendor-check
	go build -o git-vendor
```

#### CI step

```yaml
- name: Vendor compliance (strict)
  run: git-vendor verify --strict-only --quiet

- name: Vendor compliance (all)
  run: git-vendor verify --quiet
  continue-on-error: true  # lenient/info don't fail CI
```

### 3. New CLI Flags

| Flag | Behavior |
|------|----------|
| `--strict-only` | Only check vendors with `compliance: strict`. Exit 0 if all strict vendors pass, regardless of lenient/info drift. |
| `--compliance=<level>` | Temporarily override all vendors to the given level for this invocation. Equivalent to `compliance.mode: override` with `compliance.default: <level>`. |
| `--quiet` | Suppress table output, only emit exit code. For hooks/CI. |

---

## Commands

### `git-vendor verify` (extended)

Output now includes compliance level per vendor:

```text
Verifying vendored dependencies...

  ✓ charmbracelet-huh          [OK]         (lenient)
  ✗ security-lib               [MODIFIED]   (strict)
  ~ readme-sync                [DRIFT]      (info)

Summary: 3 vendors checked
  ✓ 1 verified
  ✗ 1 strict failure (1 modified)
  ~ 1 info drift (reported only)

Result: FAIL (strict compliance violated)
```

JSON output (`--format json`) adds compliance fields:

```json
{
  "schema_version": "1.1",
  "compliance_config": {
    "default": "lenient",
    "mode": "default"
  },
  "results": [
    {
      "vendor": "security-lib",
      "status": "modified",
      "compliance": "strict",
      "files": [...]
    }
  ],
  "exit_code": 1
}
```

### `git-vendor hook install` (new subcommand)

Generates enforcement hooks:

```bash
# Install pre-commit hook
git-vendor hook install --pre-commit

# Install as Makefile target
git-vendor hook install --makefile

# Show what would be generated (dry-run)
git-vendor hook install --pre-commit --dry-run
```

### `git-vendor compliance` (informational)

Show effective compliance levels for all vendors (resolves global + per-vendor + mode):

```bash
git-vendor compliance
# Output:
# Global default: lenient
# Mode: default
#
# Vendor                  Configured    Effective
# charmbracelet-huh       (inherited)   lenient
# security-lib            strict        strict
# readme-sync             info          info
```

With override mode:

```bash
git-vendor compliance
# Global default: strict
# Mode: override
#
# Vendor                  Configured    Effective
# charmbracelet-huh       (inherited)   strict
# security-lib            strict        strict
# readme-sync             info          strict  ← overridden
```

---

## Interaction with Spec 070 (Internal Compliance)

Spec 070 defines `source: internal` vendors with a `strictness` field. With 075:

1. **070's `strictness` field is replaced by 075's `compliance` field.** Same semantics, unified name across all vendor types.
2. **070 retains ownership of**: `source: internal`, transforms, section extraction, circular dependency detection, auto-sync mode.
3. **075 provides**: the compliance level model, enforcement hooks, CLI flags, and resolution logic (global default + mode).

Migration path: if 070 ships first with `strictness`, a one-time config migration renames `strictness` → `compliance` when 075 lands. Alternatively, implement 075 first so 070 can consume the model directly.

**Recommended implementation order:** 075 → 070. The compliance model is simpler and provides the enforcement foundation that 070's internal sync needs.

---

## Holes and Mitigations

### Hole 1: Override mode surprise

**Problem**: `compliance.mode: override` silently escalates `info` vendors to `strict`, breaking builds that previously passed.

**Mitigation**: `git-vendor compliance` command shows effective levels. When mode changes, `verify` output includes a notice: `⚠ Override mode active: all vendors enforced at <level>`.

### Hole 2: Hook drift from config

**Problem**: Generated pre-commit hook doesn't auto-update when compliance config changes.

**Mitigation**: Hook calls `git-vendor verify` dynamically — it reads current config at runtime. The hook script itself is stable regardless of config changes. Document that hooks MUST call the CLI, not embed logic.

### Hole 3: Partial sync leaves inconsistent state

**Problem**: User syncs vendor A (strict) but not vendor B (strict). Verify passes for A but fails for B.

**Mitigation**: This is correct behavior — verify checks current state, not intent. `git-vendor sync` without arguments syncs all vendors. Document that partial sync is supported but verify always checks everything.

### Hole 4: Team disagreement on levels

**Problem**: Developer sets vendor to `info`, security team wants `strict`.

**Mitigation**: `compliance.mode: override` exists for exactly this case. Org policy sets `override` + `strict` in CI, individual developers can use any level locally. CI is the source of truth.

### Hole 5: No `go build` integration without `go generate`

**Problem**: `go generate` is opt-in and often skipped. No way to truly gate `go build`.

**Mitigation**: This is a Go ecosystem limitation, not a git-vendor problem. The Makefile target approach (`build: vendor-check`) is the practical solution. Document this tradeoff clearly. For other ecosystems (Node, Rust), pre-build hooks are more natural.

---

## Implementation Plan

### Phase 1: Config + Resolution (3 days)
1. Add `compliance` block to `VendorConfig` type
2. Add per-vendor `compliance` field to `VendorSpec` type
3. Implement `resolveCompliance()` — global default + per-vendor + mode logic
4. Config validation: reject invalid levels, validate mode field
5. Backward compat: vendors without `compliance` inherit global default; missing global defaults to `lenient`

### Phase 2: Verify Integration (3 days)
1. Extend `verify` to include compliance level in output
2. Implement exit code logic (highest severity wins)
3. Add `--strict-only` flag
4. Add `--compliance=<level>` override flag
5. Extend JSON output with compliance fields

### Phase 3: Enforcement Hooks (2 days)
1. `git-vendor hook install --pre-commit` generator
2. `git-vendor hook install --makefile` generator
3. `--dry-run` flag for hook install
4. Documentation for CI integration patterns

### Phase 4: Compliance Command (1 day)
1. `git-vendor compliance` informational command
2. Table output showing configured vs effective levels
3. Override mode notice

---

## Success Criteria

- [ ] `compliance.default` and `compliance.mode` parse and validate in config
- [ ] Per-vendor `compliance` field works on both external and internal vendors
- [ ] `resolveCompliance()` correctly handles default/override modes
- [ ] `verify` exit codes respect compliance levels (strict=1, lenient=2, info=0)
- [ ] `--strict-only` flag filters to strict vendors only
- [ ] `--compliance=<level>` flag overrides all vendors for one invocation
- [ ] `git-vendor compliance` shows effective levels with mode resolution
- [ ] Pre-commit hook generator produces working hook
- [ ] Makefile target generator produces working target
- [ ] JSON output includes compliance metadata
- [ ] Override mode prints notice in verify output
- [ ] Backward compatible: no `compliance` block = lenient default, default mode
- [ ] All existing tests pass
- [ ] New tests for compliance resolution, exit codes, and hook generation

---

## References

- Spec 002: Verify Command Hardening (exit code semantics)
- Spec 070: Internal Project Compliance (consumes compliance model for internal vendors)
- Queue item 013: License Policy Enforcement (complementary, not overlapping)
- Queue item 022: GitHub Action (consumes compliance exit codes)
- Queue item 023: Compliance Evidence Reports (consumes compliance metadata)
- Queue item 043: Multi-Repo Lockfile Aggregation (cross-project — future spec)
