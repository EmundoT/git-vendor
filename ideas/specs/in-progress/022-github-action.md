# 022: GitHub Action

**Status:** Pending
**Priority:** P1 â€” Adoption driver
**Effort:** Medium (2-3 weeks)
**Dependencies:** 020 (Audit Command)

## Problem

Users who adopt git-vendor must manually configure CI pipelines to run verify, scan, license, and audit checks. This means:

- Writing shell scripts to parse exit codes (0=pass, 1=fail, 2=warn)
- Manually formatting PR comments from JSON output
- No caching of git-vendor binary or scan results across runs
- No standardized way to post SBOM artifacts or audit reports

A first-party GitHub Action removes this friction and becomes the primary adoption driver for CI/CD users.

## Solution

Publish `EmundoT/git-vendor-action` â€” a composite GitHub Action that installs git-vendor, runs configurable checks, posts PR comments, and uploads artifacts.

## Implementation

### Action Interface

```yaml
# .github/workflows/vendor.yml
name: Vendor Compliance
on:
  pull_request:
    paths: ['.git-vendor/**']
  push:
    branches: [main]

jobs:
  vendor-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for drift detection

      - uses: EmundoT/git-vendor-action@v1
        with:
          # Check selection (all enabled by default)
          checks: 'verify,scan,license,drift'

          # Thresholds
          scan-fail-on: 'high'        # critical|high|medium|low
          license-fail-on: 'deny'     # deny|warn

          # PR comment (default: true on pull_request)
          pr-comment: true

          # Artifact upload
          upload-sbom: true           # Upload CycloneDX SBOM as artifact
          upload-audit: true          # Upload full audit JSON as artifact
          sbom-format: 'cyclonedx'    # cyclonedx|spdx

          # git-vendor version
          version: 'latest'           # semver or 'latest'

          # Optional policy file
          policy-file: '.git-vendor-policy.yml'

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### Action Outputs

```yaml
outputs:
  result:
    description: 'Overall result: pass, warn, or fail'
  verify-result:
    description: 'Verify check result'
  scan-result:
    description: 'Scan check result'
  license-result:
    description: 'License check result'
  drift-result:
    description: 'Drift check result'
  audit-json:
    description: 'Path to full audit JSON report'
  sbom-path:
    description: 'Path to generated SBOM file'
```

### PR Comment Format

Posted via `github-script` or `gh` CLI when `pr-comment: true`:

```markdown
## ðŸ” git-vendor Audit Report

| Check | Result | Details |
|-------|--------|---------|
| Verify | âœ… Pass | 42/42 files verified |
| Scan | âš ï¸ Warn | 2 medium vulnerabilities |
| License | âœ… Pass | All 10 vendors compliant |
| Drift | âŒ Fail | 3 vendors drifted (score > 50) |

### Vulnerabilities Found

| CVE | Severity | Vendor | Fix Available |
|-----|----------|--------|---------------|
| CVE-2024-1234 | MEDIUM | auth-lib | v1.2.4 |
| CVE-2024-5678 | MEDIUM | crypto-utils | v2.0.1 |

### Drifted Vendors

| Vendor | Drift Score | Local Changes | Upstream Changes |
|--------|-------------|---------------|------------------|
| api-schema | 72.3 | 5 files | 12 files |

<details>
<summary>Full audit JSON</summary>

```json
{ ... }
```

</details>

---
*Generated by [git-vendor-action](https://github.com/EmundoT/git-vendor-action)*
```

### Action Implementation (Composite)

```yaml
# action.yml
name: 'git-vendor CI'
description: 'Run git-vendor compliance checks with PR comments and artifact upload'
branding:
  icon: 'shield'
  color: 'blue'

inputs:
  checks:
    description: 'Comma-separated checks to run'
    default: 'verify,scan,license,drift'
  scan-fail-on:
    description: 'Vulnerability severity threshold'
    default: 'high'
  license-fail-on:
    description: 'License policy threshold'
    default: 'deny'
  pr-comment:
    description: 'Post PR comment with results'
    default: 'true'
  upload-sbom:
    description: 'Upload SBOM as workflow artifact'
    default: 'false'
  upload-audit:
    description: 'Upload audit report as workflow artifact'
    default: 'false'
  sbom-format:
    description: 'SBOM format'
    default: 'cyclonedx'
  version:
    description: 'git-vendor version to install'
    default: 'latest'
  policy-file:
    description: 'Path to license policy file'
    default: '.git-vendor-policy.yml'

outputs:
  result:
    description: 'Overall result'
    value: ${{ steps.audit.outputs.result }}
  audit-json:
    description: 'Path to audit JSON'
    value: ${{ steps.audit.outputs.json-path }}

runs:
  using: 'composite'
  steps:
    - name: Install git-vendor
      shell: bash
      run: |
        if [ "${{ inputs.version }}" = "latest" ]; then
          go install github.com/EmundoT/git-vendor@latest
        else
          go install github.com/EmundoT/git-vendor@v${{ inputs.version }}
        fi

    - name: Run audit
      id: audit
      shell: bash
      run: |
        ARGS="--json --yes --quiet"

        # Build skip flags from checks input
        IFS=',' read -ra CHECKS <<< "${{ inputs.checks }}"
        for check in verify scan license drift; do
          if [[ ! " ${CHECKS[*]} " =~ " ${check} " ]]; then
            ARGS="$ARGS --skip-${check}"
          fi
        done

        ARGS="$ARGS --fail-on=${{ inputs.scan-fail-on }}"
        ARGS="$ARGS --license-fail-on=${{ inputs.license-fail-on }}"

        if [ -f "${{ inputs.policy-file }}" ]; then
          ARGS="$ARGS --policy=${{ inputs.policy-file }}"
        fi

        JSON_PATH="${{ runner.temp }}/audit-report.json"
        git-vendor audit $ARGS > "$JSON_PATH" 2>&1 || true

        RESULT=$(jq -r '.summary.result // "FAIL"' "$JSON_PATH")
        echo "result=$(echo $RESULT | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
        echo "json-path=$JSON_PATH" >> $GITHUB_OUTPUT

    - name: Generate SBOM
      if: inputs.upload-sbom == 'true'
      shell: bash
      run: |
        git-vendor sbom --format ${{ inputs.sbom-format }} \
          --output "${{ runner.temp }}/sbom.${{ inputs.sbom-format == 'cyclonedx' && 'json' || 'spdx.json' }}" \
          --quiet

    - name: Post PR comment
      if: inputs.pr-comment == 'true' && github.event_name == 'pull_request'
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Parse audit JSON into markdown table
        # Uses jq to extract summary + details
        JSON_PATH="${{ steps.audit.outputs.json-path }}"
        # ... PR comment formatting logic ...
        gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md

    - name: Upload audit artifact
      if: inputs.upload-audit == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: vendor-audit-report
        path: ${{ steps.audit.outputs.json-path }}

    - name: Upload SBOM artifact
      if: inputs.upload-sbom == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: vendor-sbom
        path: ${{ runner.temp }}/sbom.*

    - name: Set exit code
      shell: bash
      run: |
        RESULT="${{ steps.audit.outputs.result }}"
        if [ "$RESULT" = "fail" ]; then exit 1; fi
        if [ "$RESULT" = "warn" ]; then exit 0; fi  # Warn = non-blocking
        exit 0
```

### Files to Create (Separate Repo)

| File | Purpose |
|------|---------|
| `action.yml` | Composite action definition |
| `scripts/format-comment.sh` | Parse audit JSON â†’ PR comment markdown |
| `scripts/install.sh` | Cross-platform git-vendor installation |
| `README.md` | Usage docs, input/output reference |
| `.github/workflows/test.yml` | Self-test with a sample vendored project |
| `test/fixtures/` | Sample vendor.yml + vendor.lock for testing |

### Files to Modify in git-vendor

| File | Action | Purpose |
|------|--------|---------|
| `docs/CI_CD.md` | Modify | Add GitHub Action usage section |
| `README.md` | Modify | Add CI/CD badge example |

### Testing Strategy

- **Unit tests:** Shell script tests for comment formatting (given audit JSON, assert markdown output)
- **Integration test:** GitHub Actions workflow that runs the action against a fixture repo with known vendors
- **Matrix test:** ubuntu-latest, macos-latest, windows-latest
- **Edge cases:** Empty lockfile, no policy file, all checks skipped, network failure during scan

### Caching Strategy

```yaml
# Built into composite action
- uses: actions/cache@v4
  with:
    path: |
      ~/.cache/git-vendor
      .git-vendor/.cache
    key: vendor-${{ hashFiles('.git-vendor/vendor.lock') }}
    restore-keys: vendor-
```

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Go toolchain required on runner | Provide pre-built binaries as GitHub Release; action downloads binary instead of `go install` when available |
| PR comment noise on every push | Only post on pull_request events by default; update existing comment instead of creating new ones |
| Rate limits on OSV.dev in CI | Leverage scan cache (.git-vendor/.cache/); respect GIT_VENDOR_CACHE_TTL |
| Action versioning | Follow semver with `@v1` major tag; document breaking changes |
| Large audit JSON in PR comment | Use `<details>` collapse for full JSON; summary table always visible |

## References

- `internal/core/audit_service.go` â€” AuditService.Audit(), FormatAuditTable()
- `internal/core/output_mode.go` â€” OutputJSON, JSONOutput
- `internal/types/audit_types.go` â€” AuditResult, AuditSummary
- `main.go` â€” CLI flag patterns (--json, --yes, --quiet, --fail-on)
- Exit code convention: 0=PASS, 1=FAIL, 2=WARN
- Environment variables: GITHUB_TOKEN, GIT_VENDOR_OSV_ENDPOINT, GIT_VENDOR_CACHE_TTL
